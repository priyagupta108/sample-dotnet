# name: Build, Pack, and Publish to GPR

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup .NET SDK
#       uses: actions/setup-dotnet@v3
#       with:
#         dotnet-version: '7.0.x'

#     - name: Restore dependencies
#       run: dotnet restore

#     - name: Build project
#       run: dotnet build --configuration Release

#     - name: Pack project
#       run: dotnet pack --configuration Release --output ./nupkg

#     - name: Publish to GitHub Packages
#       run: dotnet nuget push ./nupkg/*.nupkg -s https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json -k ${{ secrets.GITHUB_TOKEN }}


# name: TEST

# on:
#   push:
#     branches:
#       - main
# jobs:
#   build:
#     runs-on: ${{ matrix.os }}
#     strategy:
#       matrix:
#         os: [macos-latest, macos-13, ubuntu-latest, windows-latest]
#     steps:
#       - uses: actions/checkout@v5
#       - name: Set up .NET
#         uses: actions/setup-dotnet@v5
#         with:
#            dotnet-version: 8.0.x
      
# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup .NET SDK
#       uses: actions/setup-dotnet@v4
#       with:
#         dotnet:
#           - version: 8.0.x
#             arch: x64
#           - version: 8.0.x
#             arch: arm64

#     - name: Restore dependencies
#       run: dotnet restore

#     - name: Build project
#       run: dotnet build --configuration Release

#     - name: Pack project
#       run: dotnet pack --configuration Release --output ./nupkg

#     - name: Publish to GitHub Packages
#       run: dotnet nuget push ./nupkg/*.nupkg -s https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json -k ${{ secrets.GITHUB_TOKEN }}

# name: Architecture test
# on: 
#  push:

# jobs:
#   Architecture:
#     runs-on: ${{ matrix.os }}
#     strategy:
#       fail-fast: false
#       matrix:
#             os: [macos-latest, ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
#             arch: [x64, x86, arm64, amd64, arm, s390x, ppc64le, loongarch64]


#     steps:
#       - name: Checkout
#         uses: actions/checkout@v6
#       # - uses: actions/setup-dotnet@v5
#       #   with:
#       #    dotnet-version: | 
#       #             8.0.x
#       #             8.0.x
#       # - run: dotnet --info

#       - uses: lmvysakh/setup-dotnet@support_architecture
#         with:
#          Architecture : ${{ matrix.arch }}
#          dotnet-version: | 
#                   10.0.102
              

#       - run: dotnet --info
# name: Architecture test
# on: 
#  push:
# jobs:
#   build:
#     runs-on: ubuntu-latest
#     # env:
#     #   DOTNET_ROOT: /Users/runner/.dotnet
#     steps:
#       - uses: actions/checkout@v6

#       - name: Install .NET SDK (script)
#         shell: bash
#         run: | 
#           set -euo pipefail

#           export DOTNET_ROOT="$RUNNER_TEMP/dotnet"
#           mkdir -p "$DOTNET_ROOT"
      
#           curl -fsSL https://dot.net/v1/dotnet-install.sh -o dotnet-install.sh
#           chmod +x dotnet-install.sh
      
#           ./dotnet-install.sh --version 10.0.102 --install-dir "$DOTNET_ROOT" --architecture arm64
      
#           echo "DOTNET_ROOT=$DOTNET_ROOT" >> "$GITHUB_ENV"
#           echo "$DOTNET_ROOT" >> "$GITHUB_PATH"
      
#           dotnet --info

#       - run:  dotnet --info

name: ci-dotnet-script-matrix

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v6

      - name: Install .NET (Linux/macOS via bash script)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          DOTNET_VERSION="10.0.103"

          if [ "${{ runner.os }}" = "Linux" ]; then
            desired="/usr/share/dotnet"
          else
            desired="$HOME/.dotnet"
          fi

          # Use desired path if writable, else fallback
          if mkdir -p "$desired" 2>/dev/null; then
            DOTNET_ROOT="$desired"
          else
            DOTNET_ROOT="$RUNNER_TEMP/dotnet"
            mkdir -p "$DOTNET_ROOT"
          fi

          echo "DOTNET_ROOT=$DOTNET_ROOT" >> "$GITHUB_ENV"
          echo "$DOTNET_ROOT" >> "$GITHUB_PATH"

          curl -fsSL https://dot.net/v1/dotnet-install.sh -o dotnet-install.sh
          chmod +x dotnet-install.sh

          arch="x86"
         

          ./dotnet-install.sh --version "$DOTNET_VERSION" --install-dir "$DOTNET_ROOT" --architecture "$arch"
         

      - name: Install .NET (Windows via PowerShell script)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $DotnetVersion = "10.0.103"
          $DotnetRoot = Join-Path $env:ProgramFiles "dotnet"   # your desired path

          # (Usually already exists + is writable on GitHub-hosted Windows runners; if not, you'll need admin)
          New-Item -ItemType Directory -Force -Path $DotnetRoot | Out-Null

          Invoke-WebRequest https://dot.net/v1/dotnet-install.ps1 -OutFile dotnet-install.ps1
          .\dotnet-install.ps1 -Version $DotnetVersion -InstallDir $DotnetRoot -Architecture x86

          "DOTNET_ROOT=$DotnetRoot" | Out-File -FilePath $env:GITHUB_ENV -Append
          $DotnetRoot | Out-File -FilePath $env:GITHUB_PATH -Append

         
      - name: dotnet --info
        run: dotnet --info

